generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============ NextAuth Models ============
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============ USER MODEL ============
model User {
  id                    String                 @id @default(cuid())
  name                  String?
  email                 String                 @unique
  emailVerified         DateTime?
  password              String?
  image                 String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  
  // Promo and discount
  promoCodeUsed         String?
  discountRate          Float?                 @default(0)
  
  // Subscription fields
  subscriptionTier      String                 @default("free")
  subscriptionStatus    String                 @default("active")
  stripeCustomerId      String?                @unique
  stripeSubscriptionId  String?                @unique
  subscriptionResetDate DateTime               @default(now())
  
  // Usage tracking
  generationsUsed       Int                    @default(0)
  generationsLimit      Int                    @default(3)
  projectsThisMonth     Int                    @default(0)
  projectsLimit         Int                    @default(3)
  
  // User preferences
  bio                   String?
  theme                 String                 @default("light")
  notifications         Boolean                @default(true)
  autoSave              Boolean                @default(true)
  
  // Role and integrations
  role                  String                 @default("user")
  githubAccessToken     String?
  githubUsername        String?
  
  // Two-Factor Authentication
  twoFactorEnabled      Boolean                @default(false)
  twoFactorSecret       String?
  
  // Password Reset
  resetToken            String?                @unique
  resetTokenExpiry      DateTime?
  
  // Relations
  accounts              Account[]
  activities            Activity[]
  dripEnrollments       DripEnrollment[]
  createdCampaigns      EmailCampaign[]        @relation("CreatedCampaigns")
  feedback              Feedback[]
  generations           Generation[]
  newsletterSubscribers NewsletterSubscriber[]
  projects              Project[]
  projectSharesReceived ProjectShare[]         @relation("UserProjectShares")
  projectVersions       ProjectVersion[]
  sessions              Session[]
  subscriptions         Subscription?
  deployments           Deployment[]
  vercelConnection      VercelConnection?
}

// ============ Newsletter Subscriber ============
model NewsletterSubscriber {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  status         String    @default("active")
  source         String?
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  preferences    Json?
  metadata       Json?
  userId         String?
  user           User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email], map: "idx_newslettersubscriber_email")
  @@index([status])
  @@index([subscribedAt])
  @@index([userId], map: "idx_newslettersubscriber_userid")
}

// ============ Email Campaign ============
model EmailCampaign {
  id                String      @id @default(cuid())
  name              String
  subject           String
  previewText       String?
  htmlContent       String
  status            String      @default("draft")
  scheduledFor      DateTime?
  sentAt            DateTime?
  segment           String      @default("all")
  totalSent         Int         @default(0)
  totalOpened       Int         @default(0)
  totalClicked      Int         @default(0)
  totalBounced      Int         @default(0)
  totalUnsubscribed Int         @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @default(now()) @updatedAt
  createdBy         String
  creator           User        @relation("CreatedCampaigns", fields: [createdBy], references: [id])
  sends             EmailSend[]

  @@index([createdBy], map: "idx_emailcampaign_createdby")
  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
}

// ============ Email Send ============
model EmailSend {
  id              String        @id @default(cuid())
  campaignId      String
  subscriberEmail String
  sentAt          DateTime      @default(now())
  openedAt        DateTime?
  clickedAt       DateTime?
  bouncedAt       DateTime?
  unsubscribedAt  DateTime?
  metadata        Json?
  user_id         String        @db.Uuid
  campaign        EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([campaignId], map: "idx_emailsend_campaign_id")
  @@index([subscriberEmail])
  @@index([sentAt])
  @@index([user_id], map: "idx_emailsend_user_id")
}

// ============ Drip Campaign ============
model DripCampaign {
  id          String           @id @default(cuid())
  name        String
  description String?
  status      String           @default("active")
  trigger     String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now()) @updatedAt
  emails      DripEmail[]
  enrollments DripEnrollment[]

  @@index([status])
  @@index([trigger])
}

// ============ Drip Email ============
model DripEmail {
  id          String       @id @default(cuid())
  campaignId  String
  name        String
  subject     String
  htmlContent String
  delayDays   Int
  delayHours  Int          @default(0)
  order       Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt
  campaign    DripCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([campaignId], map: "idx_dripemail_campaignid")
  @@index([order])
}

// ============ Drip Enrollment ============
model DripEnrollment {
  id             String       @id @default(cuid())
  campaignId     String
  userEmail      String
  userId         String
  enrolledAt     DateTime     @default(now())
  completedAt    DateTime?
  unsubscribedAt DateTime?
  emailsSent     Json?
  campaign       DripCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([enrolledAt])
  @@index([userEmail])
  @@index([userEmail], map: "idx_drip_enrollment_useremail")
  @@index([userId])
}

// ============ PROJECT MODEL ============
model Project {
  id             String           @id @default(cuid())
  userId         String
  name           String
  description    String?
  type           String
  code           String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  isPublic       Boolean          @default(false)
  shareToken     String?          @unique
  views          Int              @default(0)
  downloads      Int              @default(0)
  tags           String[]         @default([])
  prompt         String?
  language       String?
  framework      String?
  User           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ProjectShare   ProjectShare[]
  ProjectVersion ProjectVersion[]
  deployments    Deployment[]

  @@index([isPublic])
  @@index([shareToken])
  @@index([updatedAt])
  @@index([userId])
  @@index([userId], map: "idx_project_userid")
  @@index([userId, updatedAt])
}

// ============ PROJECT VERSION MODEL ============
model ProjectVersion {
  id          String   @id @default(cuid())
  projectId   String
  version     Int
  code        String
  description String?
  createdAt   DateTime @default(now())
  userId      String?
  Project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([userId], map: "idx_projectversion_userid")
}

// ============ GENERATION MODEL ============
model Generation {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  prompt    String
  code      String
  type      String
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
  @@index([userId], map: "idx_generation_userid")
}

// ============ ACTIVITY MODEL ============
model Activity {
  id        String   @id @default(cuid())
  userId    String
  type      String
  action    String
  metadata  Json?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
  @@index([userId], map: "idx_activity_userid")
}

// ============ FEEDBACK MODEL ============
model Feedback {
  id        String   @id @default(cuid())
  userId    String
  type      String
  subject   String
  message   String
  status    String   @default("pending")
  priority  String   @default("medium")
  response  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([userId])
  @@index([userId], map: "idx_feedback_userid")
}

// ============ PROJECT SHARE MODEL ============
model ProjectShare {
  id         String    @id @default(cuid())
  projectId  String
  sharedWith String
  permission String    @default("view")
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  Project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User      @relation("UserProjectShares", fields: [sharedWith], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([sharedWith])
  @@index([sharedWith], map: "idx_projectshare_sharedwith")
}

// ============ PROMO CODES MODEL ============
model PromoCodes {
  id            String    @id @default(cuid())
  code          String    @unique
  discountType  String
  discountValue Int
  maxUses       Int
  timesUsed     Int       @default(0)
  validUntil    DateTime?
  applicableTo  String[]  @default([])
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([active], map: "idx_promo_codes_active")
  @@index([code])
  @@index([active])
  @@map("promo_codes")
}

// ============ SUBSCRIPTION MODEL ============
model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?
  plan                 String    @default("free")
  status               String    @default("active")
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  currentPeriodStart   DateTime  @default(now())
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  User                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([userId])
  @@index([userId], map: "idx_subscription_userid")
}

// ============ ANALYTICS EVENT MODEL ============
model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String?
  event      String
  properties Json?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([event])
  @@index([userId])
  @@index([userId], map: "idx_analyticsevent_userid")
}

// ============ DEPLOYMENT MODEL ============
model Deployment {
  id                String   @id @default(cuid())
  projectId         String
  userId            String
  platform          String   // "vercel", "netlify", "cloudflare"
  deploymentUrl     String?
  deploymentId      String?  // Platform's deployment ID
  status            String   @default("pending") // pending, building, ready, error
  errorMessage      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([status])
}

// ============ VERCEL CONNECTION MODEL ============
model VercelConnection {
  id                String   @id @default(cuid())
  userId            String   @unique
  accessToken       String   // Encrypted Vercel access token
  teamId            String?  // Vercel team ID (optional)
  username          String?  // Vercel username
  email             String?
  connectedAt       DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
