generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============ NextAuth Models ============
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============ USER MODEL ============
model User {
  id                    String           @id @default(cuid())
  name                  String?
  email                 String           @unique
  emailVerified         DateTime?
  password              String?
  image                 String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  // Subscription & Billing
  promoCodeUsed         String?
  discountRate          Float?           @default(0)
  subscriptionTier      String           @default("free")
  subscriptionStatus    String           @default("active")
  stripeCustomerId      String?          @unique
  stripeSubscriptionId  String?          @unique
  
  // Usage Limits
  generationsUsed       Int              @default(0)
  generationsLimit      Int              @default(3)
  projectsThisMonth     Int              @default(0)
  projectsLimit         Int              @default(3)
  subscriptionResetDate DateTime         @default(now())
  
  // User Preferences
  bio                   String?
  theme                 String           @default("light")
  notifications         Boolean          @default(true)
  autoSave              Boolean          @default(true)
  role                  String           @default("user")
  
  // GitHub Integration
  githubAccessToken     String?
  githubUsername        String?
  
  // Relations
  Account               Account[]
  Session               Session[]
  Project               Project[]
  ProjectVersion        ProjectVersion[]
  Subscription          Subscription[]
  Generation            Generation[]
  Feedback              Feedback[]
  Activity              Activity[]
  ProjectShare          ProjectShare[]

  // Newsletter & Campaigns
  newsletterSubscriber  NewsletterSubscriber?
  emailCampaigns        EmailCampaign[]
}

// Newsletter Subscriber
model NewsletterSubscriber {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  status        String   @default("active") // active, unsubscribed, bounced
  source        String?  // signup_form, user_account, import
  subscribedAt  DateTime @default(now())
  unsubscribedAt DateTime?
  preferences   Json?    // { frequency: 'weekly', topics: ['updates', 'tips'] }
  metadata      Json?    // Additional data like location, referrer, etc.
  userId        String?  @unique
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([status])
  @@index([subscribedAt])
}

// Email Campaign
model EmailCampaign {
  id              String   @id @default(cuid())
  name            String
  subject         String
  previewText     String?
  htmlContent     String   @db.Text
  status          String   @default("draft") // draft, scheduled, sending, sent, paused
  scheduledFor    DateTime?
  sentAt          DateTime?
  segment         String   @default("all") // all, free, pro, business, enterprise
  totalSent       Int      @default(0)
  totalOpened     Int      @default(0)
  totalClicked    Int      @default(0)
  totalBounced    Int      @default(0)
  totalUnsubscribed Int    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  creator         User     @relation(fields: [createdBy], references: [id])
  sends           EmailSend[]

  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
}

// Email Send (tracking individual sends)
model EmailSend {
  id              String   @id @default(cuid())
  campaignId      String
  campaign        EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  subscriberEmail String
  sentAt          DateTime @default(now())
  openedAt        DateTime?
  clickedAt       DateTime?
  bouncedAt       DateTime?
  unsubscribedAt  DateTime?
  metadata        Json?    // Click tracking, links clicked, etc.

  @@index([campaignId])
  @@index([subscriberEmail])
  @@index([sentAt])
}

// Drip Campaign (Automated sequences)
model DripCampaign {
  id              String   @id @default(cuid())
  name            String
  description     String?
  status          String   @default("active") // active, paused, archived
  trigger         String   // signup, upgrade, project_created, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  emails          DripEmail[]
  enrollments     DripEnrollment[]

  @@index([status])
  @@index([trigger])
}

// Individual emails in a drip sequence
model DripEmail {
  id              String   @id @default(cuid())
  campaignId      String
  campaign        DripCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name            String
  subject         String
  htmlContent     String   @db.Text
  delayDays       Int      // Send X days after trigger
  delayHours      Int      @default(0)
  order           Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([campaignId])
  @@index([order])
}

// Track who's enrolled in drip campaigns
model DripEnrollment {
  id              String   @id @default(cuid())
  campaignId      String
  campaign        DripCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userEmail       String
  enrolledAt      DateTime @default(now())
  completedAt     DateTime?
  unsubscribedAt  DateTime?
  emailsSent      Json?    // Array of email IDs and send dates

  @@index([campaignId])
  @@index([userEmail])
  @@index([enrolledAt])
}

// ============ PROJECT MODEL ============
model Project {
  id             String           @id @default(cuid())
  userId         String
  name           String
  description    String?
  type           String
  prompt         String?          @db.Text
  code           String           @db.Text
  language       String?
  framework      String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  isPublic       Boolean          @default(false)
  shareToken     String?          @unique
  
  // Project Stats
  views          Int              @default(0)
  downloads      Int              @default(0)
  tags           String[]         @default([])
  
  // Relations
  User           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ProjectVersion ProjectVersion[]
  ProjectShare   ProjectShare[]
  
  @@index([shareToken])
  @@index([userId])
  @@index([isPublic])
  @@index([updatedAt])
  @@index([userId, updatedAt])
}

// ============ PROJECT VERSION MODEL ============
model ProjectVersion {
  id          String   @id @default(cuid())
  projectId   String
  version     Int
  code        String   @db.Text
  description String?
  createdAt   DateTime @default(now())
  userId      String?
  
  Project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
}

// ============ GENERATION MODEL ============
model Generation {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  prompt    String   @db.Text
  code      String   @db.Text
  type      String
  
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

// ============ ACTIVITY MODEL ============
model Activity {
  id        String   @id @default(cuid())
  userId    String
  type      String
  action    String
  metadata  Json?
  createdAt DateTime @default(now())
  
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

// ============ FEEDBACK MODEL ============
model Feedback {
  id        String   @id @default(cuid())
  userId    String
  type      String
  subject   String
  message   String   @db.Text
  status    String   @default("pending")
  priority  String   @default("medium")
  response  String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============ PROJECT SHARE MODEL ============
model ProjectShare {
  id         String    @id @default(cuid())
  projectId  String
  sharedWith String
  permission String    @default("view")
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  
  Project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User       User      @relation(fields: [sharedWith], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([sharedWith])
}

// ============ PROMO CODES MODEL ============
model PromoCodes {
  id            String    @id @default(cuid())
  code          String    @unique
  discountType  String
  discountValue Int
  maxUses       Int
  timesUsed     Int       @default(0)
  validUntil    DateTime?
  applicableTo  String[]  @default([])
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([code])
  @@index([active])
  @@map("promo_codes")
}

// ============ SUBSCRIPTION MODEL ============
model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?
  plan                 String    @default("free")
  status               String    @default("active")
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  currentPeriodStart   DateTime  @default(now())
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  
  User                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([userId])
}

// ============ ANALYTICS EVENT MODEL ============
model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String?
  event      String
  properties Json?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([event])
  @@index([userId])
}